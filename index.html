<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.0/jquery.contextMenu.js"></script>
<script src="https://kit.fontawesome.com/2a15db2084.js"></script>
<script src="https://ngld.github.io/OverlayPlugin/assets/shared/common.min.js"></script>
<script src="data/regex.js"></script>
<script src="data/abilities.js"></script>
<style></style>
<link rel="stylesheet" href="skins/default/styles/resources.css" />
<link rel="stylesheet" href="styles/colors.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.0/jquery.contextMenu.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/fontawesome.min.css" />
<script>
var locked = true;
var gridshown = false;
const UPDATE_INTERVAL = 10;

var currentSettings = null;
var currentPlayer = null;
var currentStats = {
	skillSpeed: 0,
	spellSpeed: 0
};

var activeDotBars = new Map();
var activeBuffBars = new Map();
var activeCountdowns = new Map();

var canvas = $('#grid').attr({width: window.innerWidth, height: window.innerHeight});

$(function() {
	loadSettings();
	$("[id$=bar]").draggable(
		{
			stop: function (event, ui) {
				saveSettings();
			}
		}
	);
	$("[id$=bar]").draggable("disable");

	$(':root').contextMenu({
        selector: 'body', 
        callback: function(key, options) {
			switch(key){
				case "lock":
					toggleLock();
					break;
				case "grid":
					toggleGrid();
					break;
				case "import":
					importSettings();
					break;
				case "export":
					exportSettings();
					break;
				case "settings":
					let openSettings = window.open("settings.html");
					var settingsTimer = setInterval(function() {   
						if(openSettings.closed) {  
							clearInterval(settingsTimer);  
							loadSettings();  
						}  
					}, 1000); 
					break;
			}
        },
        items: {
            "lock": {name: "Lock/Unlock Bars", icon: "fas fa-lock-open"},
			"grid": {name: "Toggle Grid", icon: "fas fa-border-all"},
			"import": {name: "Import Settings", icon: "fas fa-upload"},
			"export": {name: "Export Settings", icon: "fas fa-download"},
			"settings": {name: "Settings", icon: "fas fa-cog"},
            "sep1": "---------",
            "quit": {name: "Close", icon: function($element, key, item){ return 'context-menu-icon context-menu-icon-quit'; }}
        }
    });
});

function loadSettings(){
	if(localStorage.getItem("settings") !== null){
		let settings = JSON.parse(localStorage.getItem("settings"));
	}else{
		settings = {};
	}

	if(!settings.healthbar.hasOwnProperty("enabled")) {
		settings.healthbar.enabled = true;
		$("#health-bar").show();
	}
	
	if(!settings.healthbar.enabled) $("#health-bar").hide();

	if(!settings.healthbar.hasOwnProperty("textenabled")) settings.healthbar.textenabled = true;
	if(!settings.healthbar.color) settings.healthbar.color = "--filter-dark-green";
	$("#health-bar").css("--healthBarColor", `var(${settings.healthbar.color})`);


	if(settings.healthbar.x){
		$("#health-bar").css("left", settings.healthbar.x);
	}else{
		settings.healthbar.x = 0;
	}

	if(settings.healthbar.y){
		$("#health-bar").css("top", settings.healthbar.y);
	}else{
		settings.healthbar.y = 216;
	}

	if(!settings.manabar.hasOwnProperty("enabled")) {
		settings.manabar.enabled = true;
		$("#mana-bar").show();
	}
	
	if(!settings.manabar.enabled) $("#mana-bar").hide();

	if(!settings.manabar.hasOwnProperty("textenabled")) settings.manabar.textenabled = true;
	if(!settings.manabar.color) settings.manabar.color = "--filter-light-pink";
	$("#mana-bar").css("--manaBarColor", `var(${settings.manabar.color})`);
	
	if(settings.manabar.x){
		$("#mana-bar").css("left", settings.manabar.x);
	}else{
		settings.manabar.x = 0;
	}

	if(settings.manabar.y){
		$("#mana-bar").css("top", settings.manabar.y);
	}else{
		settings.manabar.y = 232;
	}

	if(!settings.timerbar.enabled) settings.timerbar.enabled = true;
	if(!settings.timerbar.textenabled) settings.timerbar.textenabled = true;
	if(!settings.timerbar.color) settings.timerbar.color = "--filter-dark-red";
	$("#timer-bar").css("--pulltimerBarColor", `var(${settings.timerbar.color})`);

	if(settings.timerbar.x){
		$("#timer-bar").css("left", settings.timerbar.x);
	}else{
		settings.timerbar.x = 0;
	}

	if(settings.timerbar.y){
		$("#timer-bar").css("top", settings.timerbar.y);
	}else{
		settings.timerbar.y = 200;
	}

	if(!settings.dottimerbar.enabled) settings.dottimerbar.enabled = true;
	if(!settings.dottimerbar.textenabled) settings.dottimerbar.textenabled = true;
	if(!settings.dottimerbar.imageenabled) settings.dottimerbar.imageenabled = true;
	if(!settings.dottimerbar.multidotenabled) settings.dottimerbar.multidotenabled = false;
	if(!settings.dottimerbar.growdirection) settings.dottimerbar.growdirection = 1;
	if(!settings.dottimerbar.padding) settings.dottimerbar.padding = 20;


	if(settings.dottimerbar.x){
		$("#dot-timer-bar").css("left", settings.dottimerbar.x);
	}else{
		settings.dottimerbar.x = 0;
	}

	if(settings.dottimerbar.y){
		$("#dot-timer-bar").css("top", settings.dottimerbar.y);
	}else{
		settings.dottimerbar.y = 100;
	}

	if(!settings.bufftimerbar.enabled) settings.bufftimerbar.enabled = true;
	if(!settings.bufftimerbar.textenabled) settings.bufftimerbar.textenabled = true;
	if(!settings.bufftimerbar.imageenabled) settings.bufftimerbar.imageenabled = true;
	if(!settings.bufftimerbar.growdirection) settings.bufftimerbar.growdirection = 1;
	if(!settings.bufftimerbar.padding) settings.bufftimerbar.padding = 20;

	if(settings.bufftimerbar.x){
		$("#buff-timer-bar").css("left", settings.bufftimerbar.x);
	}else{
		settings.bufftimerbar.x = 0;
	}

	if(settings.bufftimerbar.y){
		$("#buff-timer-bar").css("top", settings.bufftimerbar.y);
	}else{
		settings.bufftimerbar.y = 116;
	}
	currentSettings = settings;
	saveSettings();
}


function importSettings(){
	$(`<div>
			<br />
			Copy in your settings string to import <br />
			<input type="text" placeholder="Copy settings string here" id="settingstext"><br />
			<span id="importalert"></span>
		</div>`).dialog({
		modal: true,
		title: "Import Settings",
		buttons: {
			"OK": function (){
				let settings = JSON.parse(atob($('#settingstext').val()));
				if(settings.hasOwnProperty("healthbar")){
					localStorage.setItem("settings", JSON.stringify(settings));
					loadSettings();
					$(this).dialog('close');
				}else{
					$('#importalert').text("Invalid settings string, please doublecheck what you have pasted in.")
				}
			},
			'Cancel': function () {
				$(this).dialog('close');
			}
		}
	});
}

function saveSettings(){
	currentSettings.healthbar.x = $("#health-bar").css("left").replace("px", "");
	currentSettings.healthbar.y = $("#health-bar").css("top").replace("px", "");

	currentSettings.manabar.x = $("#mana-bar").css("left").replace("px", "");
	currentSettings.manabar.y = $("#mana-bar").css("top").replace("px", "");

	currentSettings.dottimerbar.x = $("#dot-timer-bar").css("left").replace("px", "");
	currentSettings.dottimerbar.y = $("#dot-timer-bar").css("top").replace("px", "");
	
	currentSettings.bufftimerbar.x = $("#buff-timer-bar").css("left").replace("px", "");
	currentSettings.bufftimerbar.y = $("#buff-timer-bar").css("top").replace("px", "");
	
	localStorage.setItem("settings", JSON.stringify(currentSettings));
}

function exportSettings(){
	if(localStorage.getItem("settings") == null){
		saveSettings();
	}
	$(`<div>
			<br />
			Copy this string and keep it safe! <br />
			<input type="text" value="${btoa(localStorage.getItem("settings"))}" onclick="this.select();"">
		</div>`).dialog({
		modal: true,
		title: "Export Settings",
		buttons: {
			"OK": function (){
				$(this).dialog('close');
			}
		}
	});
}

function startTimer(duration, selector, hideTimer = false){
	let timems = duration * 1000;
	$(selector).attr("max", timems);
	$(selector).attr("value", timems);
	$(selector).attr("data-label", timems);

	if(hideTimer) $(selector).show();

	let timeLeft = timems;
	let countdownTimer = setInterval(function(){
		timeLeft -= UPDATE_INTERVAL;
		$(selector).attr("value", timeLeft);
		$(selector).attr("data-label", (timeLeft / 1000).toFixed(1));
		if(timeLeft <= 0){
			clearInterval(countdownTimer);
			setTimeout(function(){
				if(hideTimer) $(selector).hide();
			}, UPDATE_INTERVAL);			
		}
	}, UPDATE_INTERVAL);
	activeCountdowns.set(selector, countdownTimer);
}

function resetTimers(){
	for(let [selector, countdownTimer] of activeCountdowns){
		clearInterval(countdownTimer);
	}
	for(let [id, selector] of activeBuffBars){
		$(selector).remove();
		$(selector.replace("bar", "image")).remove();
	}
	for(let [id, selector] of activeDotBars){
		$(selector).remove();
		$(selector.replace("bar", "image")).remove();
	}
	activeBuffBars.clear();
	activeDotBars.clear();
	activeCountdowns.clear();
}

function drawGrid(){
	let width = window.innerWidth;
	let height = window.innerHeight;

	let canvas = $('#grid').attr({width: window.innerWidth, height: window.innerHeight});
	let canvasContext = canvas.get(0).getContext("2d");
	canvasContext.beginPath();

	for (var x = 0; x <= width; x+= 25){
		canvasContext.moveTo(0.5 + x, 0);
		canvasContext.lineTo(0.5 + x, height);
	}

	for (var y = 0; y <= height; y+= 25){
		canvasContext.moveTo(0, 0.5 + y);
		canvasContext.lineTo(width, 0.5 + y);
	}

	canvasContext.strokeStyle = "black";
    canvasContext.stroke();
}

function clearGrid(){
	let canvas = $('#grid').attr({width: window.innerWidth, height: window.innerHeight});
	let canvasContext = $('#grid').get(0).getContext("2d");
	canvasContext.clearRect(0, 0, canvas.width, canvas.height);
}

function toggleLock(){
	if(locked){
		$("#timer-bar").show();
		$("#dot-timer-bar").show();
		$("#buff-timer-bar").show();
		$("[id$=bar]").draggable("enable");
		locked = false;
	}else{
		$("#timer-bar").hide();
		$("#dot-timer-bar").hide();
		$("#buff-timer-bar").hide();
		$("[id$=bar]").draggable("disable");
		locked = true;
	}	
}

function toggleGrid(){
	if(!gridshown){
		drawGrid();
		gridshown = true;
	}else{
		clearGrid();
		gridshown = false;
	}	
}

function addFilterColorToElement(classId, filterColor){
	$("style").append(`.${classId}::-webkit-progress-value { filter: var(${filterColor}); }`);
}

document.addEventListener('onOverlayStateUpdate', function(e) {
	if (!e.detail.isLocked) {
		$(":root").css("background", "rgba(0,0,255,0.5)");
	}else{
		$(":root").css("background", "");
	}
});

addOverlayListener("onPlayerChangedEvent", (e) => onPlayerChangedEvent(e));
addOverlayListener("onLogEvent", (e) => onLogEvent(e));
addOverlayListener("onPartyWipe", (e) => onPartyWipe(e));
addOverlayListener("onZoneChangedEvent", (e) => onChangeZone(e));

startOverlayEvents();

function onPlayerChangedEvent(e){
	if(currentPlayer !== null && currentPlayer.job !== e.detail.job){
		resetTimers();
	}
	currentPlayer = e.detail;
	$("#health-bar").attr("max", currentPlayer.maxHP);
	$("#health-bar").attr("value", currentPlayer.currentHP);
	$("#health-bar").attr("data-label", currentSettings.healthbar.textenabled ? `${currentPlayer.currentHP} / ${currentPlayer.maxHP}` : "");

	$("#mana-bar").attr("max", currentPlayer.maxMP);
	$("#mana-bar").attr("value", currentPlayer.currentMP);
	$("#mana-bar").attr("data-label", currentSettings.manabar.textenabled ? `${currentPlayer.currentMP} / ${currentPlayer.maxMP}` : "");
}

function onLogEvent(e){
	for (logLine of e.detail.logs){		
		for(let logType of Object.keys(regexList)){
			let regexObject = regexList[logType];
			let regex = new RegExp(regexObject.regex);
			if(regex.test(logLine)){
				let matches = regexObject.matches;
				for(let match of Object.keys(matches)){
					console.log(logLine);
					let matchObject = matches[match];
					let innerRegex = new RegExp(matchObject.regex);
					let regexMatch = innerRegex.exec(logLine);
					if(regexMatch !== null){
						let logFunction = window[matchObject.function];
						if (typeof logFunction === "function") logFunction(regexMatch.groups);
					}
				}
			}
		}
	}
}

function onPartyWipe(e){
	resetTimers();
}

function onChangeZone(e){
	resetTimers();
}

function startCountdownTimer(parameters){
	startTimer(parameters.seconds, "#timer-bar", true);
}

function handlePlayerStats(parameters){
	currentStats.skillSpeed = (1000 + Math.floor(130 * (parameters.sks - 380) / 3300)) / 1000;
	currentStats.spellSpeed = (1000 + Math.floor(130 * (parameters.sps - 380) / 3300)) / 1000;
}

function handleEffect(parameters){
	if(parameters.player === currentPlayer.name){
		if(parameters.player === currentPlayer.name){
			// Effect is a self-buff.
		}else{
			// Effect is a DoT
		}
		let ability = abilityList.find(x => x.name == parameters.effect);

		let targetBarSelector = `#${ability.type.toLowerCase()}-timer-bar`;
		let targetImageSelector = `#${ability.type.toLowerCase()}-image`;
		let selectorBar = `#${ability.id}-bar`;
		let selectorImage = `#${ability.id}-image`;

		if(!activeDotBars.has(ability.id) && !activeBuffBars.has(ability.id) ){
			let activeCount = 0;
			switch(ability.type){
				case "DoT":{
					activeDotBars.set(ability.id, selectorBar);
					activeCount = activeDotBars.size;
					break;
				}
				case "Buff":{
					activeBuffBars.set(ability.id, selectorBar);
					activeCount = activeBuffBars.size;
					break;
				}
			}
			let newBar = $(targetBarSelector).clone().prop("id", selectorBar.replace("#", ""));
			$(targetBarSelector).after(newBar);
			let newImage = $(targetImageSelector).clone().prop("id", selectorImage.replace("#", ""));
			$(targetImageSelector).after(newImage);

			$(selectorBar).show();
			$(selectorBar).css("left", $(targetBarSelector).css("left"));
			$(selectorBar).addClass(`bar-${ability.id}`);
			addFilterColorToElement(`bar-${ability.id}`, ability.color);
			$(selectorBar).css("top", parseInt($(targetBarSelector).css("top").replace("px", "")) + (currentSettings[`${ability.type.toLowerCase()}timerbar`].padding * ability.order));

			if(currentSettings[`${ability.type.toLowerCase()}timerbar`].imageenabled){
				$(selectorImage).show();
				$(selectorImage).attr("src", `https://xivapi.com${ability.icon}`);
				$(selectorImage).css("left", parseInt($(targetBarSelector).css("left").replace("px", "")) - 20);
				$(selectorImage).css("top", parseInt($(targetBarSelector).css("top").replace("px", "")) + (currentSettings[`${ability.type.toLowerCase()}timerbar`].padding * ability.order) - 4);
			}
			
		}
		if(activeCountdowns.has(selectorBar)) clearInterval(activeCountdowns.get(selectorBar))
		startTimer(parameters.duration, selectorBar);
	}
}
</script>
<canvas id="grid"></canvas>
<img id="dot-image" class="small-image" /><progress width="154" height="15" id="dot-timer-bar" class="bar" value="10" data-label="DoT Timers Anchor"></progress>
<img id="buff-image" class="small-image" /><progress width="154" height="15" id="buff-timer-bar" class="bar" value="10" data-label="Buff Timers Anchor"></progress>
<progress width="154" height="15" id="timer-bar" class="bar" value="10" data-label="Pulltimer"></progress>
<progress width="154" height="15" id="health-bar" class="bar" value="1" data-label="10000 / 10000"></progress>
<progress width="154" height="15" id="mana-bar" class="bar" value="1" data-label="10000 / 10000"></progress>