<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.0/jquery.contextMenu.js"></script>
<script src="https://kit.fontawesome.com/2a15db2084.js"></script>
<script src="https://ngld.github.io/OverlayPlugin/assets/shared/common.min.js"></script>
<script src="data/regex.js"></script>
<script src="data/abilities.js"></script>
<script src="data/jobs.js"></script>
<style>
	body{
		overflow: hidden;
	}
</style>
<link rel="stylesheet" href="styles/resources.css" />
<link rel="stylesheet" href="styles/colors.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.0/jquery.contextMenu.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/fontawesome.min.css" />
<script>
var locked = true;
var gridshown = false;
const UPDATE_INTERVAL = 10;

var inCombat = false;
var currentSettings = null;
var currentPlayer = null;
var currentPartyList = [];
var currentStats = {
	skillSpeed: 0,
	spellSpeed: 0,
	stacks: 0,
	maxStacks: 0
};

var blockRuinGained = false;

var activeDotBars = new Map();
var activeBuffBars = new Map();
var activeRaidBuffs = new Map();
var activeCountdowns = new Map();

//var canvas = $("#grid").attr({width: window.innerWidth, height: window.innerHeight}); d

$(function() {
	loadSettings();
	toggleHideOutOfCombatElements();
	$("[id$=bar]").draggable(
		{
			stop: function () {
				saveSettings();
			}
		}
	);
	$("[id$=bar]").draggable("disable");

	$(":root").contextMenu({
		selector: "body", 
		callback: function(key) {
			switch(key){
			case "lock":
				toggleLock();
				break;
			case "grid":
				toggleGrid();
				break;
			case "import":
				importSettings();
				break;
			case "export":
				exportSettings();
				break;
			case "settings":
				let openSettings = window.open("settings.html");
				var settingsTimer = setInterval(function() {   
					if(openSettings.closed) {  
						clearInterval(settingsTimer);  
						loadSettings();
						generateRaidBuffs();
					}  
				}, 1000); 
				break;
			}
		},
		items: {
			"lock": {name: "Lock/Unlock Bars", icon: "fas fa-lock-open"},
			"grid": {name: "Toggle Grid", icon: "fas fa-border-all"},
			"import": {name: "Import Settings", icon: "fas fa-upload"},
			"export": {name: "Export Settings", icon: "fas fa-download"},
			"settings": {name: "Settings", icon: "fas fa-cog"},
			"sep1": "---------",
			"quit": {name: "Close", icon: function(){ return "context-menu-icon context-menu-icon-quit"; }}
		}
	});
});

function loadSettings(){
	let settings = {};

	if(localStorage.getItem("settings") !== null){
		settings = JSON.parse(localStorage.getItem("settings"));
	}

	// SKIN SETTINGS
	if(!settings.hasOwnProperty("skin")) {
		settings.skin = "default";
	}

	if($("#skin").length == 0){
		$("head").append(`<link id="skin" rel="stylesheet" href="skins/${settings.skin}/styles/resources.css">`);
	}else{
		$("#skin").attr("href", `skins/${settings.skin}/styles/resources.css`);
	}
	
	// HEALTHBAR SETTINGS
	if(!settings.hasOwnProperty("healthbar")) {
		settings.healthbar = {};
	}

	if(!settings.healthbar.hasOwnProperty("enabled")) {
		settings.healthbar.enabled = true;
		$("#health-bar").show();
	}
	
	if(!settings.healthbar.enabled) $("#health-bar").hide();

	if(!settings.healthbar.hasOwnProperty("hideoutofcombat")) {
		settings.healthbar.hideoutofcombat = false;
	}

	if(!settings.healthbar.hasOwnProperty("textenabled")) settings.healthbar.textenabled = true;
	if(!settings.healthbar.color) settings.healthbar.color = "--filter-dark-green";
	$("#health-bar").css("--healthBarColor", `var(${settings.healthbar.color})`);

	if(settings.healthbar.scale){
		$("#health-bar").css("width", settings.healthbar.scale * 154);
		$("#health-bar").css("height", settings.healthbar.scale * 15);
	}else{
		settings.healthbar.scale = 1;
	}

	if(settings.healthbar.x){
		$("#health-bar").css("left", settings.healthbar.x);
	}else{
		settings.healthbar.x = 0;
	}

	if(settings.healthbar.y){
		$("#health-bar").css("top", settings.healthbar.y);
	}else{
		settings.healthbar.y = 216;
	}

	// MANABAR SETTINGS
	if(!settings.hasOwnProperty("manabar")) {
		settings.manabar = {};
	}

	if(!settings.manabar.hasOwnProperty("enabled")) {
		settings.manabar.enabled = true;
		$("#mana-bar").show();
	}
	
	if(!settings.manabar.enabled) $("#mana-bar").hide();

	if(!settings.manabar.hasOwnProperty("hideoutofcombat")) {
		settings.manabar.hideoutofcombat = false;
	}

	if(!settings.manabar.hasOwnProperty("textenabled")) settings.manabar.textenabled = true;
	if(!settings.manabar.color) settings.manabar.color = "--filter-light-pink";
	$("#mana-bar").css("--manaBarColor", `var(${settings.manabar.color})`);
	
	if(settings.manabar.scale){
		$("#mana-bar").css("width", settings.manabar.scale * 154);
		$("#mana-bar").css("height", settings.manabar.scale * 15);
	}else{
		settings.manabar.scale = 1;
	}

	if(settings.manabar.x){
		$("#mana-bar").css("left", settings.manabar.x);
	}else{
		settings.manabar.x = 0;
	}

	if(settings.manabar.y){
		$("#mana-bar").css("top", settings.manabar.y);
	}else{
		settings.manabar.y = 232;
	}

	// PULLTIMER SETTINGS
	if(!settings.hasOwnProperty("timerbar")) {
		settings.timerbar = {};
	}

	if(!settings.timerbar.enabled) settings.timerbar.enabled = true;
	if(!settings.timerbar.textenabled) settings.timerbar.textenabled = true;
	if(!settings.timerbar.color) settings.timerbar.color = "--filter-dark-red";
	$("#timer-bar").css("--pulltimerBarColor", `var(${settings.timerbar.color})`);

	if(settings.timerbar.scale){
		$("#timer-bar").css("width", settings.timerbar.scale * 154);
		$("#timer-bar").css("height", settings.timerbar.scale * 15);
	}else{
		settings.timerbar.scale = 1;
	}

	if(settings.timerbar.x){
		$("#timer-bar").css("left", settings.timerbar.x);
	}else{
		settings.timerbar.x = 0;
	}

	if(settings.timerbar.y){
		$("#timer-bar").css("top", settings.timerbar.y);
	}else{
		settings.timerbar.y = 200;
	}

	// DOT TIMER SETTINGS
	if(!settings.hasOwnProperty("dottimerbar")) {
		settings.dottimerbar = {};
	}

	if(!settings.dottimerbar.enabled) settings.dottimerbar.enabled = true;
	if(!settings.dottimerbar.hideoutofcombat) settings.dottimerbar.hideoutofcombat = false;
	if(!settings.dottimerbar.hidewhendroppedoff) settings.dottimerbar.hidewhendroppedoff = false;
	if(!settings.dottimerbar.textenabled) settings.dottimerbar.textenabled = true;
	if(!settings.dottimerbar.imageenabled) settings.dottimerbar.imageenabled = true;
	if(!settings.dottimerbar.multidotenabled) settings.dottimerbar.multidotenabled = false;
	if(!settings.dottimerbar.growdirection) settings.dottimerbar.growdirection = "1";
	if(!settings.dottimerbar.padding) settings.dottimerbar.padding = "20";

	if(settings.dottimerbar.scale){
		$("#dot-timer-bar").css("width", settings.dottimerbar.scale * 154);
		$("#dot-timer-bar").css("height", settings.dottimerbar.scale * 15);
	}else{
		settings.dottimerbar.scale = 1;
	}
	
	if(settings.dottimerbar.x){
		$("#dot-timer-bar").css("left", settings.dottimerbar.x);
	}else{
		settings.dottimerbar.x = 0;
	}

	if(settings.dottimerbar.y){
		$("#dot-timer-bar").css("top", settings.dottimerbar.y);
	}else{
		settings.dottimerbar.y = 100;
	}

	// BUFF TIMER SETTINGS
	if(!settings.hasOwnProperty("bufftimerbar")) {
		settings.bufftimerbar = {};
	}

	if(!settings.bufftimerbar.enabled) settings.bufftimerbar.enabled = true;
	if(!settings.bufftimerbar.hideoutofcombat) settings.bufftimerbar.hideoutofcombat = false;
	if(!settings.bufftimerbar.hidewhendroppedoff) settings.bufftimerbar.hidewhendroppedoff = false;
	if(!settings.bufftimerbar.textenabled) settings.bufftimerbar.textenabled = true;
	if(!settings.bufftimerbar.imageenabled) settings.bufftimerbar.imageenabled = true;
	if(!settings.bufftimerbar.growdirection) settings.bufftimerbar.growdirection = "1";
	if(!settings.bufftimerbar.padding) settings.bufftimerbar.padding = "20";
	
	if(settings.bufftimerbar.scale){
		$("#buff-timer-bar").css("width", settings.bufftimerbar.scale * 154);
		$("#buff-timer-bar").css("height", settings.bufftimerbar.scale * 15);
	}else{
		settings.bufftimerbar.scale = 1;
	}

	if(settings.bufftimerbar.x){
		$("#buff-timer-bar").css("left", settings.bufftimerbar.x);
	}else{
		settings.bufftimerbar.x = 0;
	}

	if(settings.bufftimerbar.y){
		$("#buff-timer-bar").css("top", settings.bufftimerbar.y);
	}else{
		settings.bufftimerbar.y = 116;
	}

	// STACKBAR SETTINGS
	if(!settings.hasOwnProperty("stacksbar")) {
		settings.stacksbar = {};
	}

	if(!settings.stacksbar.hasOwnProperty("enabled")) {
		settings.stacksbar.enabled = true;
		$("#stacks-bar").show();
	}
	
	if(!settings.stacksbar.enabled) $("#stacks-bar").hide();

	if(!settings.stacksbar.hideoutofcombat) settings.stacksbar.hideoutofcombat = false;

	if(!settings.stacksbar.color) settings.stacksbar.color = "--filter-bright-red";
	$("#stacks-bar").css("--stacksColor", `var(${settings.stacksbar.color})`);

	if(settings.stacksbar.scale){
		$("#stacks-bar").attr("width", settings.stacksbar.scale * (4 * 25));
		$("#stacks-bar").attr("height", settings.stacksbar.scale * 21);
		$("#stacks-1").attr("width", settings.stacksbar.scale * 25);
		$("#stacks-2").attr("width", settings.stacksbar.scale * 25);
		$("#stacks-3").attr("width", settings.stacksbar.scale * 25);
		$("#stacks-4").attr("width", settings.stacksbar.scale * 25);
		$("[id^=stacks-background]").css("margin-left", 0 - (settings.stacksbar.scale * 4));
	}else{
		settings.stacksbar.scale = 1;
	}

	if(settings.stacksbar.x){
		$("#stacks-bar").css("left", settings.stacksbar.x);
	}else{
		settings.stacksbar.x = 0;
	}

	if(settings.stacksbar.y){
		$("#stacks-bar").css("top", settings.stacksbar.y);
	}else{
		settings.stacksbar.y = 170;
	}
	
	// RAIDBUFF SETTINGS
	if(!settings.hasOwnProperty("raidbuffs")) {
		settings.raidbuffs = {};
	}

	if(!settings.raidbuffs.hasOwnProperty("enabled")) {
		settings.raidbuffs.enabled = true;
		$("#raid-buffs-bar").show();
	}
	
	if(!settings.raidbuffs.enabled) $("#raid-buffs-bar").hide();

	if(!settings.raidbuffs.hasOwnProperty("hideoutofcombat")) {
		settings.raidbuffs.hideoutofcombat = false;
	}

	if(!settings.raidbuffs.hasOwnProperty("alwaysshow")) {
		settings.raidbuffs.alwaysshow = true;
	}

	if(!settings.raidbuffs.hasOwnProperty("hidewhensolo")) {
		settings.raidbuffs.hidewhensolo = false;
	}

	if(!settings.raidbuffs.padding) settings.raidbuffs.padding = "5";
	if(!settings.raidbuffs.scale) settings.raidbuffs.scale = "1";
	if(!settings.raidbuffs.columns) settings.raidbuffs.columns = 8;

	//if(!settings.raidbuffs.hasOwnProperty("textenabled")) settings.raidbuffs.textenabled = true;

	if(settings.raidbuffs.x){
		$("#raid-buffs-bar").css("left", settings.raidbuffs.x);
	}else{
		settings.raidbuffs.x = 0;
	}

	if(settings.raidbuffs.y){
		$("#raid-buffs-bar").css("top", settings.raidbuffs.y);
	}else{
		settings.raidbuffs.y = 216;
	}

	currentSettings = settings;
	saveSettings();
	
	generateJobStacks();
	if(!currentSettings.raidbuffs.hidewhensolo) $("#raid-buffs-bar").show();
}

function importSettings(){
	$(`<div>
			<br />
			Copy in your settings string to import <br />
			<input type="text" placeholder="Copy settings string here" id="settingstext"><br />
			<span id="importalert"></span>
		</div>`).dialog({
		modal: true,
		title: "Import Settings",
		buttons: {
			"OK": function (){
				let settings = JSON.parse(atob($("#settingstext").val()));
				if(settings.hasOwnProperty("healthbar")){
					localStorage.setItem("settings", JSON.stringify(settings));
					loadSettings();
					$(this).dialog("close");
				}else{
					$("#importalert").text("Invalid settings string, please doublecheck what you have pasted in.");
				}
			},
			"Cancel": function () {
				$(this).dialog("close");
			}
		}
	});
}

function saveSettings(){	
	currentSettings.healthbar.x = parseInt($("#health-bar").css("left").replace("px", ""));
	currentSettings.healthbar.y = parseInt($("#health-bar").css("top").replace("px", ""));
	$("#health-bar").css("--healthFontSize", currentSettings.healthbar.scale * 10);
	$("#health-bar").css("--healthFontX", currentSettings.healthbar.scale * 5);
	$("#health-bar").css("--healthFontY", currentSettings.healthbar.scale * -14);

	currentSettings.manabar.x = parseInt($("#mana-bar").css("left").replace("px", ""));
	currentSettings.manabar.y = parseInt($("#mana-bar").css("top").replace("px", ""));
	$("#mana-bar").css("--manaFontSize", currentSettings.manabar.scale * 10);
	$("#mana-bar").css("--manaFontX", currentSettings.manabar.scale * 5);
	$("#mana-bar").css("--manaFontY", currentSettings.manabar.scale * -14);

	currentSettings.timerbar.x = parseInt($("#timer-bar").css("left").replace("px", ""));
	currentSettings.timerbar.y = parseInt($("#timer-bar").css("top").replace("px", ""));
	$("#timer-bar").css("--timerFontSize", currentSettings.timerbar.scale * 10);
	$("#timer-bar").css("--timerFontX", currentSettings.timerbar.scale * 5);
	$("#timer-bar").css("--timerFontY", currentSettings.timerbar.scale * -14);

	currentSettings.dottimerbar.x = parseInt($("#dot-timer-bar").css("left").replace("px", ""));
	currentSettings.dottimerbar.y = parseInt($("#dot-timer-bar").css("top").replace("px", ""));
	$("#dot-timer-bar").css("--dotFontSize", currentSettings.dottimerbar.scale * 10);
	$("#dot-timer-bar").css("--dotFontX", currentSettings.dottimerbar.scale * 5);
	$("#dot-timer-bar").css("--dotFontY", currentSettings.dottimerbar.scale * -14);
	
	currentSettings.bufftimerbar.x = parseInt($("#buff-timer-bar").css("left").replace("px", ""));
	currentSettings.bufftimerbar.y = parseInt($("#buff-timer-bar").css("top").replace("px", ""));
	$("#buff-timer-bar").css("--buffFontSize", currentSettings.bufftimerbar.scale * 10);
	$("#buff-timer-bar").css("--buffFontX", currentSettings.bufftimerbar.scale * 5);
	$("#buff-timer-bar").css("--buffFontY", currentSettings.bufftimerbar.scale * -14);

	currentSettings.stacksbar.x = parseInt($("#stacks-bar").css("left").replace("px", ""));
	currentSettings.stacksbar.y = parseInt($("#stacks-bar").css("top").replace("px", ""));

	currentSettings.raidbuffs.x = parseInt($("#raid-buffs-bar").css("left").replace("px", ""));
	currentSettings.raidbuffs.y = parseInt($("#raid-buffs-bar").css("top").replace("px", ""));
	
	localStorage.setItem("settings", JSON.stringify(currentSettings));
}

function exportSettings(){
	if(localStorage.getItem("settings") == null){
		saveSettings();
	}
	$(`<div>
			<br />
			Copy this string and keep it safe! <br />
			<input type="text" value="${btoa(localStorage.getItem("settings"))}" onclick="this.select();"">
		</div>`).dialog({
		modal: true,
		title: "Export Settings",
		buttons: {
			"OK": function (){
				$(this).dialog("close");
			}
		}
	});
}

function startBarTimer(duration, selector, hideTimer = false){
	let timems = duration * 1000;
	$(selector).attr("max", timems);
	$(selector).attr("value", timems);
	$(selector).attr("data-label", timems);

	if(hideTimer) $(selector).show();

	let timeLeft = timems;
	let countdownTimer = setInterval(function(){
		timeLeft -= UPDATE_INTERVAL;
		$(selector).attr("value", timeLeft);
		$(selector).attr("data-label", (timeLeft / 1000).toFixed(1));
		if(timeLeft <= 0){
			clearInterval(countdownTimer);
			setTimeout(function(){
				if(hideTimer && selector !== "#timer-bar"){
					if(selector !== "#timer-bar"){
						removeTimerBar(selector);
					}else{
						$(selector).hide();
					}					
				}
			}, UPDATE_INTERVAL);			
		}
	}, UPDATE_INTERVAL);
	activeCountdowns.set(selector, countdownTimer);
}

function startAbilityTimer(duration, selector, previousIcon = null){
	let timems = duration * 1000;

	$(selector).text(duration);

	let timeLeft = timems;
	let countdownTimer = setInterval(function(){
		timeLeft -= UPDATE_INTERVAL;
		
		$(selector).text((timeLeft / 1000).toFixed(0));
		if(timeLeft <= 0){
			clearInterval(countdownTimer);
			setTimeout(function(){
				stopAbilityTimer(selector, previousIcon);
			}, UPDATE_INTERVAL);			
		}
	}, UPDATE_INTERVAL);
	activeCountdowns.set(selector, countdownTimer);
}

function stopAbilityTimer(selector, previousIcon = null){
	if(currentSettings.raidbuffs.alwaysshow){
		$(selector).text("");
		if(selector.endsWith("duration")){
			if(previousIcon !== null) $(selector.replace("duration", "image")).attr("src", previousIcon);						
			$(selector.replace("duration", "cooldown")).show();
			$(selector.replace("duration", "active")).hide();
			
			if($(selector.replace("duration", "cooldown")).text().length !== 0){
				$(selector.replace("duration", "overlay")).attr("src", `skins/${currentSettings.skin}/images/icon-overlay-cooldown.png`);
			}
		}
		if(selector.endsWith("cooldown")){
			$(selector.replace("cooldown", "overlay")).attr("src", `skins/${currentSettings.skin}/images/icon-overlay.png`);
		}
	}else{
		$(selector.replace("-duration", "").replace("-cooldown", "")).remove();
		activeCountdowns.delete(selector);
	}
}

function removeTimerBar(selector){
	$(selector).remove();
	$(selector.replace("timer", "image")).remove();
	if(activeBuffBars.has(parseInt(selector.match(/[0-9]+/g)[0]))) activeBuffBars.delete(parseInt(selector.match(/[0-9]+/g)[0]));
	if(activeDotBars.has(parseInt(selector.match(/[0-9]+/g)[0]))) activeDotBars.delete(parseInt(selector.match(/[0-9]+/g)[0]));
}

function resetTimers(){
	for(let [, countdownTimer] of activeCountdowns){
		clearInterval(countdownTimer);
	}
	for(let [, selector] of activeBuffBars){
		removeTimerBar(selector);
	}
	for(let [, selector] of activeDotBars){
		removeTimerBar(selector);
	}
	activeBuffBars.clear();
	activeDotBars.clear();
	activeCountdowns.clear();
}

function drawGrid(){
	let width = window.innerWidth;
	let height = window.innerHeight;

	let canvas = $("#grid").attr({width: window.innerWidth, height: window.innerHeight});
	let canvasContext = canvas.get(0).getContext("2d");
	canvasContext.beginPath();

	for (let x = 0; x <= width; x+= 25){
		canvasContext.moveTo(0.5 + x, 0);
		canvasContext.lineTo(0.5 + x, height);
	}

	for (let y = 0; y <= height; y+= 25){
		canvasContext.moveTo(0, 0.5 + y);
		canvasContext.lineTo(width, 0.5 + y);
	}

	canvasContext.strokeStyle = "black";
	canvasContext.stroke();
}

function generateJobStacks(){
	$("#stacks-bar").empty();
	for(let i = 1; i <=4; i++){
		$("#stacks-bar").append(`<div id="stacks-background-${i}" class="stack-background stack-hidden"><img id="stacks-${i}" class="stack-color" src="skins/${currentSettings.skin}/images/arrow-fill-empty.png" /></div>`);
	}	
}

function generateRaidBuffs(){
	let raidAbilityList = [];
	$("#raid-buffs-bar").empty();
	let playerIndex = 0;
	for(let partyMember of currentPartyList){
		for(let ability of abilityList.filter(x => x.type === "RaidBuff" && x.job === partyMember.job.name && x.level <= currentPlayer.level)){
			let pushAbility = true;
			console.log(ability);
			if(ability.hasOwnProperty("extra")){
				if(ability.extra.hasOwnProperty("is_card") || ability.extra.hasOwnProperty("is_song") || ability.extra.hasOwnProperty("is_ss") || ability.extra.hasOwnProperty("is_ts")) pushAbility = false;
			}
			if(pushAbility){
				raidAbilityList.push({
					player: partyMember,
					playerIndex: playerIndex,
					ability: ability
				});
			}			
		}
		playerIndex++;
	}
	if(currentSettings.raidbuffs.alwaysshow) generateRaidBuffElements(raidAbilityList, currentSettings.raidbuffs.columns);
}

function generateRaidBuffElements(raidAbilityList, columns){
	let rows = Math.ceil(raidAbilityList.length / columns);	
	let abilityIndex = 0;
	for(let i = 1; i <= rows; i++){
		$("#raid-buffs-bar").append(`<div id="raid-buffs-row-${i}" class="ability-row" style="padding-top: ${currentSettings.raidbuffs.padding};"></div>`);
		for (let j = 1; j <= columns; j++){
			let raidAbility = raidAbilityList[abilityIndex];
			generateRaidBuffAbility(raidAbility.playerIndex, raidAbility.ability, i);			
			if(abilityIndex == raidAbilityList.length - 1) break;
			abilityIndex++;
		}
	}
}

function generateRaidBuffAbility(playerIndex, ability, row, generateRow = false){
	if(generateRow){
		if(row === 0) row = 1;
		if($(`#raid-buffs-row-${row}`).length === 0) $("#raid-buffs-bar").append(`<div id="raid-buffs-row-${row}" class="ability-row" style="padding-top: ${currentSettings.raidbuffs.padding};"></div>`);
	}
	$(`#raid-buffs-row-${row}`).append(`<div id="raid-buffs-${playerIndex}-${ability.id}" class="ability-container" style="padding-right: ${currentSettings.raidbuffs.padding};"></div>`);
	$(`#raid-buffs-${playerIndex}-${ability.id}`).append(`<img id="raid-buffs-${playerIndex}-${ability.id}-image" class="ability-image" src="https://xivapi.com${ability.icon}" width="${currentSettings.raidbuffs.scale * 40}" height="${currentSettings.raidbuffs.scale * 40}" style="left: ${currentSettings.raidbuffs.scale * 4}; top: ${currentSettings.raidbuffs.scale * 2};" />`);
	$(`#raid-buffs-${playerIndex}-${ability.id}`).append(`<img id="raid-buffs-${playerIndex}-${ability.id}-active" class="icon-active" src="skins/${currentSettings.skin}/images/combo.gif" width="${currentSettings.raidbuffs.scale * 42}" height="${currentSettings.raidbuffs.scale * 42}" style="left: ${currentSettings.raidbuffs.scale * 3}; top: ${currentSettings.raidbuffs.scale * 1}; display: none;" />`);
	$(`#raid-buffs-${playerIndex}-${ability.id}`).append(`<img id="raid-buffs-${playerIndex}-${ability.id}-overlay" class="icon-overlay" src="skins/${currentSettings.skin}/images/icon-overlay.png" width="${currentSettings.raidbuffs.scale * 48}" height="${currentSettings.raidbuffs.scale * 48}" />`);
	$(`#raid-buffs-${playerIndex}-${ability.id}`).append(`<span id="raid-buffs-${playerIndex}-${ability.id}-cooldown" class="ability-text text-cooldown" style="padding-top: ${currentSettings.raidbuffs.scale * 8}; padding-left: ${currentSettings.raidbuffs.scale * 2}; --cooldownOutline: black; --cooldownColor: white; --cooldownFontSize: ${currentSettings.raidbuffs.scale * 24};"></span>`);
	$(`#raid-buffs-${playerIndex}-${ability.id}`).append(`<span id="raid-buffs-${playerIndex}-${ability.id}-duration" class="ability-text text-duration" style="padding-top: ${currentSettings.raidbuffs.scale * 8}; padding-left: ${currentSettings.raidbuffs.scale * 2}; --durationOutline: black; --durationColor: orange; --durationFontSize: ${currentSettings.raidbuffs.scale * 24};"></span>`);
}

function startRaidAbilityTimers(playerIndex, ability, onYou = true, abilityHolder = null){
	let abilityUsed = abilityHolder === null ? ability : abilityHolder;
	let usingAbilityHolder = !(abilityHolder === null);
	let selector = `#raid-buffs-${playerIndex}-${abilityUsed.id}`;
	if(activeRaidBuffs.has(ability.id)){	
		if(activeCountdowns.has(`${selector}-duration`)){
			clearInterval(activeCountdowns.get(`${selector}-duration`));
		}
		if(activeCountdowns.has(`${selector}-cooldown`)){
			clearInterval(activeCountdowns.get(`${selector}-cooldown`));
		}	 
		stopAbilityTimer(`${selector}-cooldown`, null);
		stopAbilityTimer(`${selector}-duration`, null);
	}
	if(onYou){
		if(!currentSettings.raidbuffs.alwaysshow){
			generateRaidBuffAbility(playerIndex, ability, Math.ceil(activeRaidBuffs.size / currentSettings.raidbuffs.columns), true);
		}
		$(`${selector}-overlay`).attr("src", `skins/${currentSettings.skin}/images/icon-overlay.png`);
		$(`${selector}-active`).show();
		$(`${selector}-duration`).show();
		$(`${selector}-duration`).text(ability.duration);
		$(`${selector}-cooldown`).hide();
		if(usingAbilityHolder){
			let previousIcon = `https://xivapi.com${abilityHolder.icon}`;
			$(`${selector}-image`).attr("src", `https://xivapi.com${ability.icon}`);
			startAbilityTimer(ability.duration, `${selector}-duration`, previousIcon);
		}else{
			startAbilityTimer(ability.duration, `${selector}-duration`);
		}
		
	}else{
		$(`${selector}-overlay`).attr("src", ability.cooldown > 0 ? `skins/${currentSettings.skin}/images/icon-overlay-cooldown.png` : `skins/${currentSettings.skin}/images/icon-overlay.png`);
		$(`${selector}-cooldown`).show();
		$(`${selector}-cooldown`).text(ability.cooldown);
	}
	if(currentSettings.raidbuffs.alwaysshow) startAbilityTimer(ability.cooldown, `${selector}-cooldown`);
	activeRaidBuffs.set(ability.id, selector);
}

function clearGrid(){
	let canvas = $("#grid").attr({width: window.innerWidth, height: window.innerHeight});
	let canvasContext = $("#grid").get(0).getContext("2d");
	canvasContext.clearRect(0, 0, canvas.width, canvas.height);
}

function toggleLock(){
	if(locked){
		$("#timer-bar").show();
		$("#dot-timer-bar").show();
		$("#buff-timer-bar").show();
		if(currentSettings.raidbuffs.hidewhensolo && currentPartyList.length == 1) $("#raid-buffs-bar").show();
		$("[id$=bar]").draggable("enable");
		adjustJobStacks(2,4, true);
		if(!inCombat){
			toggleHideOutOfCombatElements();
		}
		locked = false;
	}else{
		$("#timer-bar").hide();
		$("#dot-timer-bar").hide();
		$("#buff-timer-bar").hide();
		if(currentSettings.raidbuffs.hidewhensolo && currentPartyList.length == 1) $("#raid-buffs-bar").hide();
		$("[id$=bar]").draggable("disable");
		adjustJobStacks(currentStats.stacks, currentStats.maxStacks, true);
		if(!inCombat){
			toggleHideOutOfCombatElements();
		}
		locked = true;
	}	
}

function toggleHideOutOfCombatElements(){
	currentSettings.healthbar.hideoutofcombat && !inCombat ? $("#health-bar").addClass("hide-in-combat") : $("#health-bar").removeClass("hide-in-combat");
	currentSettings.manabar.hideoutofcombat && !inCombat  ? $("#mana-bar").addClass("hide-in-combat") : $("#mana-bar").removeClass("hide-in-combat");
	currentSettings.dottimerbar.hideoutofcombat && !inCombat ? $("[id$=dot-timer]").addClass("hide-in-combat") : $("[id$=dot-timer]").removeClass("hide-in-combat");
	currentSettings.dottimerbar.hideoutofcombat && !inCombat ? $("[id$=dot-image]").addClass("hide-in-combat") : $("[id$=dot-image]").removeClass("hide-in-combat");
	currentSettings.bufftimerbar.hideoutofcombat && !inCombat ? $("[id$=buff-timer]").addClass("hide-in-combat") : $("[id$=buff-timer]").removeClass("hide-in-combat");
	currentSettings.bufftimerbar.hideoutofcombat && !inCombat ? $("[id$=buff-image]").addClass("hide-in-combat") : $("[id$=buff-image]").removeClass("hide-in-combat");
	currentSettings.stacksbar.hideoutofcombat && !inCombat ? $("#stacks-bar").addClass("hide-in-combat") : $("#stacks-bar").removeClass("hide-in-combat");
	currentSettings.raidbuffs.hideoutofcombat && !inCombat ? $("#raid-buffs-bar").addClass("hide-in-combat") : $("#raid-buffs-bar").removeClass("hide-in-combat");
}

function adjustJobStacks(value, max, noAdd = false){
	if(!noAdd){
		currentStats.stacks = value;
		if(currentPlayer.job === "SAM" && currentStats.maxStacks === 0 && !noAdd){
			initializeSam(true);
			max = 3;
		}
		if(currentPlayer.job === "SMN" && currentStats.maxStacks === 0 && !noAdd){
			initializeSmn(true);
			max = 4;
		}
	}
	
	for(let i = 1; i <= 4; i++){
		let backgroundSelector = `#stacks-background-${i}`;
		let selector = `#stacks-${i}`;
		if(i <= max){
			if($(backgroundSelector).hasClass("stack-hidden")){
				$(backgroundSelector).removeClass("stack-hidden");
			}
		}else{
			if(!$(backgroundSelector).hasClass("stack-hidden")){
				$(backgroundSelector).addClass("stack-hidden");
			}
		}
		$(selector).attr("src", i <= value ? `skins/${currentSettings.skin}/images/arrow-fill.png` : `skins/${currentSettings.skin}/images/arrow-fill-empty.png`);
	}
}

function initializeSam(addStack = false){
	currentStats.stacks = addStack ? 1 : 0;
	currentStats.maxStacks = 3;
}

function initializeSmn(addStack = false){
	currentStats.stacks = addStack ? 1 : 0;
	currentStats.maxStacks = 4;
}

function toggleGrid(){
	if(!gridshown){
		drawGrid();
		gridshown = true;
	}else{
		clearGrid();
		gridshown = false;
	}	
}

function addFilterColorToElement(classId, filterColor){
	$("style").append(`.${classId}::-webkit-progress-value { filter: var(${filterColor}); }`);
}

document.addEventListener("onOverlayStateUpdate", function(e) {
	if (!e.detail.isLocked) {
		$(":root").css("background", "rgba(0,0,255,0.5)");
	}else{
		$(":root").css("background", "");
	}
});

addOverlayListener("onPlayerChangedEvent", (e) => onPlayerChangedEvent(e));
addOverlayListener("onLogEvent", (e) => onLogEvent(e));
addOverlayListener("onPartyWipe", (e) => onPartyWipe(e));
addOverlayListener("onInCombatChangedEvent", (e) => onInCombatChangedEvent(e));
addOverlayListener("onZoneChangedEvent", (e) => onChangeZone(e));
addOverlayListener("PartyChanged", (e) => onPartyChanged(e));

startOverlayEvents();

function onPlayerChangedEvent(e){
	let changePartyList = false;
	if(currentPlayer !== null && currentPlayer.job !== e.detail.job){
		if(e.detail.job === "SAM") {
			initializeSam();
			adjustJobStacks(currentStats.stacks, currentStats.maxStacks);
		}
		if(e.detail.job === "SMN") {
			initializeSmn();
			adjustJobStacks(currentStats.stacks, currentStats.maxStacks);
		}
		resetTimers();
		if(currentPartyList.length === 1){
			currentPartyList = [];
			changePartyList = true;
		}
	}
	currentPlayer = e.detail;
	if(currentPartyList.length === 0){
		setupSoloParty();
	}
	
	$("#health-bar").attr("max", currentPlayer.maxHP);
	$("#health-bar").attr("value", currentPlayer.currentHP);
	$("#health-bar").attr("data-label", currentSettings.healthbar.textenabled ? `${currentPlayer.currentHP} / ${currentPlayer.maxHP}` : "");

	$("#mana-bar").attr("max", currentPlayer.maxMP);
	$("#mana-bar").attr("value", currentPlayer.currentMP);
	$("#mana-bar").attr("data-label", currentSettings.manabar.textenabled ? `${currentPlayer.currentMP} / ${currentPlayer.maxMP}` : "");
}

function onLogEvent(e){
	for (let logLine of e.detail.logs){
		//console.log(logLine);
		for(let logType of Object.keys(regexList)){
			let regexObject = regexList[logType];
			let regex = new RegExp(regexObject.regex);
			if(regex.test(logLine)){
				let matches = regexObject.matches;
				for(let match of Object.keys(matches)){
					//console.log(logLine);
					let matchObject = matches[match];
					let innerRegex = new RegExp(matchObject.regex);
					let regexMatch = innerRegex.exec(logLine);
					if(regexMatch !== null){
						console.log(logLine);
						let logFunction = window[matchObject.function];
						if (typeof logFunction === "function") logFunction(regexMatch.groups);
					}
				}
			}
		}
	}
}

function onPartyWipe(e){
	if(currentPlayer.job === "SAM") initializeSam();
	if(currentPlayer.job === "SMN") initializeSmn();
	resetTimers();
	generateRaidBuffs();
}

function onChangeZone(e){
	resetTimers();
}

function onPartyChanged(e){
	generatePartyList(e.party);
}

function generatePartyList(party){
	currentPartyList = [];
	for (let partyMember of party)
	{
		currentPartyList.push({
			id: partyMember.id,
			inParty: partyMember.inParty,
			job: jobList.find(x => x.id === partyMember.job),
			name: partyMember.name,
			worldId: partyMember.worldId
		});
	}
	console.log(currentPartyList);
	if(currentPartyList.length != 0) generateRaidBuffs();
}

function setupSoloParty(){
	currentPartyList.push({
		id: currentPlayer.id,
		inParty: false,
		job: jobList.find(x => x.name === currentPlayer.job),
		name: currentPlayer.name,
		worldId: null
	});
	generateRaidBuffs();
}

function onInCombatChangedEvent(e){
	if(inCombat === e.detail.inGameCombat){
		return;
	}

	inCombat = e.detail.inGameCombat;
	toggleHideOutOfCombatElements();
}

function startCountdownTimer(parameters){
	startBarTimer(parameters.seconds, "#timer-bar", true);
}

function onInstanceStart(parameters){
	generateRaidBuffs();
}

function onInstanceEnd(parameters){
	resetTimers();
	generateRaidBuffs();
}

function handlePlayerStats(parameters){
	currentStats.skillSpeed = (1000 + Math.floor(130 * (parameters.sks - 380) / 3300)) / 1000;
	currentStats.spellSpeed = (1000 + Math.floor(130 * (parameters.sps - 380) / 3300)) / 1000;
}

function handleEffect(parameters){
	let byYou = (parameters.player === currentPlayer.name);
	let onYou = (parameters.target === currentPlayer.name);
	let playerIndex = currentPartyList.findIndex(x => x.name === parameters.player);
	let ability = undefined;
	for (ability of abilityList.filter(x => x.name == parameters.effect)){
		if(ability === undefined) return;

		if(ability.type === "RaidBuff"){
			if(ability.name === "Standard Step" || ability.name === "Technical Step") return;
			if(ability.hasOwnProperty("extra")){
				if(ability.extra.is_song){
					let abilityHolder = abilityList.find(x => x.name === "Song");
					if(byYou){
						ability.duration = 30;
						startRaidAbilityTimers(playerIndex, ability, true, currentSettings.raidbuffs.alwaysshow ? abilityHolder : ability);
						return;
					}
					if(onYou){
						ability.duration = 5;
						startRaidAbilityTimers(playerIndex, ability, true, currentSettings.raidbuffs.alwaysshow ? abilityHolder : ability);
					}
				}
			}
			if(onYou) startRaidAbilityTimers(playerIndex, ability, true);
		}
		if(ability.type === "Stacks" && byYou){
			if(!blockRuinGained) adjustJobStacks(currentStats.stacks + 1, currentStats.maxStacks);
		}
		if((ability.type === "DoT"  && byYou) || (ability.type === "Buff" && byYou)){
			let targetBarSelector = `#${ability.type.toLowerCase()}-timer-bar`;
			let targetImageSelector = `#${ability.type.toLowerCase()}-image`;
			let selectorBar = `#${ability.id}-${ability.type.toLowerCase()}-timer`;
			let selectorImage = `#${ability.id}-${ability.type.toLowerCase()}-image`;
			if(!activeDotBars.has(ability.id) && !activeBuffBars.has(ability.id) ){
				let activeCount = 0;
				switch(ability.type){
				case "DoT":{
					activeDotBars.set(ability.id, selectorBar);
					activeCount = activeDotBars.size;
					break;
				}
				case "Buff":{
					activeBuffBars.set(ability.id, selectorBar);
					activeCount = activeBuffBars.size;
					break;
				}
				}
				let newBar = $(targetBarSelector).clone().prop("id", selectorBar.replace("#", ""));
				$(targetBarSelector).after(newBar);
				let newImage = $(targetImageSelector).clone().prop("id", selectorImage.replace("#", ""));
				$(targetImageSelector).after(newImage);

				$(selectorBar).show();
				$(selectorBar).addClass(`bar-${ability.id}`);
				$(selectorBar).addClass(`${ability.type.toLowerCase()}-font-size`);
				addFilterColorToElement(`bar-${ability.id}`, ability.color);

				$(targetBarSelector).attr("data-font-size", currentSettings[`${ability.type.toLowerCase()}timerbar`].scale * 10);

				switch(currentSettings[`${ability.type.toLowerCase()}timerbar`].growdirection){
				case "1": {
					// Down					
					$(selectorBar).css("left", $(targetBarSelector).css("left"));
					$(selectorBar).css("top", parseInt($(targetBarSelector).css("top").replace("px", "")) + (currentSettings[`${ability.type.toLowerCase()}timerbar`].padding * ability.order));
					break;
				}
				case "2": {
					// Up
					$(selectorBar).css("left", $(targetBarSelector).css("left"));
					$(selectorBar).css("top", parseInt($(targetBarSelector).css("top").replace("px", "")) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].padding * ability.order));
					break;
				}
				case "3": {
					// Left
					$(selectorBar).css("top", $(targetBarSelector).css("top"));
					$(selectorBar).css("left", parseInt($(targetBarSelector).css("left").replace("px", "")) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].padding * ability.order));
					break;
				}
				case "4": {
					// Right
					$(selectorBar).css("top", $(targetBarSelector).css("top"));
					$(selectorBar).css("left", parseInt($(targetBarSelector).css("left").replace("px", "")) + (currentSettings[`${ability.type.toLowerCase()}timerbar`].padding * ability.order));
					break;
				}
				}			

				if(currentSettings[`${ability.type.toLowerCase()}timerbar`].imageenabled){
					$(selectorImage).show();
					$(selectorImage).attr("src", `https://xivapi.com${ability.icon}`);
					$(selectorImage).css("image-rendering", currentSettings[`${ability.type.toLowerCase()}timerbar`].scale > 1 ? "pixelated" : "-webkit-optimize-contrast" );
					$(selectorImage).css("height", currentSettings[`${ability.type.toLowerCase()}timerbar`].scale * 22);

					switch(currentSettings[`${ability.type.toLowerCase()}timerbar`].growdirection){
					case "1": {
						// Down					
						$(selectorImage).css("left", parseInt($(targetBarSelector).css("left").replace("px", "")) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].scale * 20));
						$(selectorImage).css("top", parseInt($(targetBarSelector).css("top").replace("px", "")) + (currentSettings[`${ability.type.toLowerCase()}timerbar`].padding * ability.order) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].scale * 4));
						break;
					}
					case "2": {
						// Up
						$(selectorImage).css("left", parseInt($(targetBarSelector).css("left").replace("px", "")) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].scale * 20));
						$(selectorImage).css("top", parseInt($(targetBarSelector).css("top").replace("px", "")) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].padding * ability.order) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].scale * 4));
						break;
					}
					case "3": {
						// Left
						$(selectorImage).css("top", parseInt($(targetBarSelector).css("top").replace("px", "")) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].scale * 4));
						$(selectorImage).css("left", parseInt($(targetBarSelector).css("left").replace("px", "")) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].padding * ability.order) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].scale * 20));
						break;
					}
					case "4": {
						// Right
						$(selectorImage).css("top", parseInt($(targetBarSelector).css("top").replace("px", "")) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].scale * 4));
						$(selectorImage).css("top", parseInt($(targetBarSelector).css("top").replace("px", "")) + (currentSettings[`${ability.type.toLowerCase()}timerbar`].padding * ability.order) - (currentSettings[`${ability.type.toLowerCase()}timerbar`].scale * 20));
						break;
					}
					}
					
				}
			}
			if(activeCountdowns.has(selectorBar)) clearInterval(activeCountdowns.get(selectorBar));
			startBarTimer(parameters.duration, selectorBar, currentSettings[`${ability.type.toLowerCase()}timerbar`].hidewhendroppedoff);
		}
	}
}


function handleSkill(parameters){
	let byYou = (parameters.player === currentPlayer.name);
	let onYou = false;
	if (parameters.target){
		if(parameters.target === currentPlayer.name) onYou = true;
	}

	let playerIndex = currentPartyList.findIndex(x => x.name === parameters.player);
	let ability = undefined;
	for (ability of abilityList.filter(x => x.id == parseInt(parameters.skillid, 16))){
		if(ability === undefined){
			return;
		}
		if(ability.name === "Shoha" && byYou){
			adjustJobStacks(0, currentStats.maxStacks);
		}
		if(ability.name === "Ruin IV" && byYou){
			adjustJobStacks(currentStats.stacks - 1, currentStats.maxStacks);
			blockRuinGained = true;
			setTimeout(function(){
				blockRuinGained = false;
			}, 1000);
		}
		if(ability.type === "RaidBuff"){
			console.log(ability);
			if(ability.hasOwnProperty("extra")){
				if(ability.extra.is_card){
					let abilityHolder = abilityList.find(x => x.name === "Play");
					if(onYou){
						startRaidAbilityTimers(playerIndex, ability, true, currentSettings.raidbuffs.alwaysshow ? abilityHolder : ability);
					}
				}
				if(ability.extra.cooldown_only){
					startRaidAbilityTimers(playerIndex, ability, false);
				}
				if(ability.extra.is_song){
					let abilityHolder = abilityList.find(x => x.name === "Song");
					if(byYou){
						if(!currentSettings.raidbuffs.alwaysshow) {
							for(let song of abilityList.filter(x => x.hasOwnProperty("extra") && x.extra.hasOwnProperty("is_song"))){
								let selector = `#raid-buffs-${playerIndex}-${song.id}`;
								if(activeCountdowns.has(`${selector}-duration`)){
									clearInterval(activeCountdowns.get(`${selector}-duration`));
								}
								if(activeCountdowns.has(`${selector}-cooldown`)){
									clearInterval(activeCountdowns.get(`${selector}-cooldown`));
								}	 
								stopAbilityTimer(`${selector}-cooldown`, null);
								stopAbilityTimer(`${selector}-duration`, null);
							}
						}
						startRaidAbilityTimers(playerIndex, ability, true, currentSettings.raidbuffs.alwaysshow ? abilityHolder : ability);
					} 
				}
				if(ability.extra.is_ss){
					let abilityHolder = abilityList.find(x => x.id === 15997);
					startRaidAbilityTimers(playerIndex, ability, true, currentSettings.raidbuffs.alwaysshow ? abilityHolder : ability);
				}
				if(ability.extra.is_ts){
					let abilityHolder = abilityList.find(x => x.id === 16004);
					startRaidAbilityTimers(playerIndex, ability, true, currentSettings.raidbuffs.alwaysshow ? abilityHolder : ability);
				}
			}
			else{
				if ((!onYou && ability.name === "Dragon Sight") || (byYou && ability.name === "Battle Voice")){
					onYou = false;
				}else{
					onYou = true;
				}
				startRaidAbilityTimers(playerIndex, ability, onYou);
			}
		}
	}	
}
</script>
<body>
	<canvas id="grid"></canvas>
	<img id="dot-image" class="small-image" /><progress width="154" height="15" id="dot-timer-bar" class="bar styled-bar" value="10" data-label="DoT Timers Anchor"></progress>
	<img id="buff-image" class="small-image" /><progress width="154" height="15" id="buff-timer-bar" class="bar styled-bar" value="10" data-label="Buff Timers Anchor"></progress>
	<div id="stacks-bar" data-label="Job Stacks Anchor" style="padding-left: 10px">
		<div id="stacks-background-1" class="stack-background stack-hidden"><img id="stacks-1" class="stack-color" src="skins/material-dark/images/arrow-fill-empty.png" /></div>
		<div id="stacks-background-2" class="stack-background stack-hidden"><img id="stacks-2" class="stack-color" src="skins/material-dark/images/arrow-fill-empty.png" /></div>
		<div id="stacks-background-3" class="stack-background stack-hidden"><img id="stacks-3" class="stack-color" src="skins/material-dark/images/arrow-fill-empty.png" /></div>
		<div id="stacks-background-4" class="stack-background stack-hidden"><img id="stacks-4" class="stack-color" src="skins/material-dark/images/arrow-fill-empty.png" /></div>
	</div>
	<div id="raid-buffs-bar">

	</div>
	<progress width="154" height="15" id="timer-bar" class="bar styled-bar" value="10" data-label="Pulltimer"></progress>
	<progress width="154" height="15" id="health-bar" class="bar styled-bar" value="1" data-label="10000 / 10000"></progress>
	<progress width="154" height="15" id="mana-bar" class="bar styled-bar" value="1" data-label="10000 / 10000"></progress>
</body>